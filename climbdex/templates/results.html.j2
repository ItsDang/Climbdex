<!DOCTYPE html>
<html>

<head>
  {% include 'head.html.j2'%}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
  <style>
    #div-results-list {
      max-height: 800px;
      overflow-y: scroll;
    }

    .fw-light {
      font-size: 0.9em;
    }

    .modal label.btn.btn-outline-primary.flex-fill:last-child {
      border-bottom-right-radius: 6px !important;
      border-top-right-radius: 6px !important;
    }

    .modal label.btn.btn-outline-primary.flex-fill {
      border-bottom-right-radius: 0px !important;
      border-top-right-radius: 0px !important;
    }

    .btn-group>.btn-group:not(:last-child)>.btn,
    .btn-group>.btn.dropdown-toggle-split:first-child,
    .btn-group>.btn:not(:last-child):not(.dropdown-toggle) {
      border-top-right-radius: 6px !important;
      border-bottom-right-radius: 6px !important;
    }

    /* simulate button click for swipe gestures */
    .simulated-button-click {
      color: var(--bs-btn-hover-color);
      background-color: var(--bs-btn-hover-bg);
      border-color: var(--bs-btn-hover-border-color);
    }

    .star-rating {
      direction: rtl;
      display: inline-flex;
      font-size: 2rem;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      cursor: pointer;
      color: #ddd;
    }

    .star-rating input:checked~label {
      color: #ffd700;
    }

    .star-rating label:hover,
    .star-rating label:hover~label {
      color: #ffd700;
    }

    button#button-prev,
    button#button-next {
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container-sm text-center">
    {% include 'heading.html.j2' %}
    {% include 'alert.html.j2' %}
    <div class="row justify-content-md-center">
      <div class="col-md-5 card p-3 g-2 vh-100">
        <h4 id="header-results-count"></h4>
        <p class="mb-3"><small><a id="anchor-back">Back to filter selection</a></small></p>
        <div id="div-results-list" class="list-group"></div>
      </div>
      <div class="col-md-5 card p-3 g-2 vh-100" id="div-climb">
        <div class="row g-0">
          <div class="col-2">
            <button type="button" class="btn btn-outline-primary" id="button-prev" disabled>&larr;</button>
            <br>
            <button id="button-illuminate" class="btn btn-outline-primary position-relative" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightbulb"
                viewBox="0 0 16 16">
                <path
                  d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a2 2 0 0 0-.453-.618A5.98 5.98 0 0 1 2 6m6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1" />
              </svg>
              </a>
          </div>
          <div class="col-8">
            <h4 id="header-climb-name"></h4>
            <h6 id="header-climb-setter"></h6>
            <p id="paragraph-climb-stats"></p>
          </div>

          <div class="col-2">
            <button type="button" class="btn btn-outline-primary" id="button-next" disabled>&rarr;</button>
            <br>
            <!-- Dropdown menu -->
              <button type="button" class="btn btn-outline-primary dropdown" data-toggle="dropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list"
                  viewBox="0 0 16 16">
                  <path fill-rule="evenodd"
                    d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5" />
                </svg>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                {% if request.cookies %}
                <li><button class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#tickModal">Log Climb</li>
                <li><button class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#statsModal">Statistics</li>
                {% endif %}
                <li>
                  <a id="anchor-beta" class="btn btn-outline-primary position-relative dropdown-item">Beta
                      <span id="span-beta-count" class="position-absolute badge rounded-pill bg-danger">
                       0
                      </span>
                    </a>
                </li>
                    {% if request.cookies %}
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">Logout</a></li>
                    {% endif %}
              </ul>
        </div>
        <svg id="svg-climb" viewbox="0 0 0 0" xmlns="http://www.w3.org/2000/svg"></svg>
        <div class="row">
          <p id="paragraph-climb-description" class="small mt-2 d-none"></p>
        </div>
      </div>
    </div>
    <div class="row justify-content-md-center mt-3">
      {% include 'footer.html.j2' %}
    </div>

<!-- Tick Modal -->
<div class="modal fade" id="tickModal" tabindex="-1" aria-labelledby="tickModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tick, Rate and Comment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div>
          <h4 id="modal-climb-name"></h4>
          <p id="modal-climb-stats"></p>
        </div>
        <form id="ratingForm">
          <div class="mb-3">
            <div class="star-rating">
              <input type="radio" id="star3" name="rating" value="3">
              <label for="star3">&#9733;</label>
              <input type="radio" id="star2" name="rating" value="2">
              <label for="star2">&#9733;</label>
              <input type="radio" id="star1" name="rating" value="1">
              <label for="star1">&#9733;</label>
            </div>
          </div>
          <div class="mb-3">
            <div class="btn-group d-flex" role="group">
              <input class="btn-check" type="radio" name="attemptType" id="flash" value="flash" autocomplete="off"
                checked>
              <label class="btn btn-outline-primary flex-fill" for="flash">Flash</label>
              <input class="btn-check" type="radio" name="attemptType" id="send" value="send" autocomplete="off">
              <label class="btn btn-outline-primary flex-fill" for="send">Send</label>
              <input class="btn-check" type="radio" name="attemptType" id="attempt" value="attempt" autocomplete="off"
                style="display:none">
              <label class="btn btn-outline-primary flex-fill" for="attempt" style="display:none">Attempt</label>
            </div>
          </div>
          <div class="mb-3 pt-3" id="attemptsSection" style="display: none;">
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="decreaseAttempts">-</button>
              <input type="text" class="form-control text-center" id="attempts" value="1 try" readonly>
              <button class="btn btn-outline-secondary" type="button" id="increaseAttempts">+</button>
            </div>
          </div>
          <div class="mb-3 pt-3">
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="decreaseDifficulty">-</button>
              <input type="text" class="form-control text-center" id="difficulty" value="" readonly>
              <button class="btn btn-outline-secondary" type="button" id="increaseDifficulty">+</button>
            </div>
          </div>
          <div class="mb-3 pt-3">
            <textarea class="form-control" id="comment" rows="3" placeholder="Add comments, beta, notes..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveTick">Save tick</button>
      </div>
      <div class="alter-settings alert alert-success" role="alert">
        Tick successfully saved!
      </div>
      <div class="alter-settings alert alert-danger" role="alert">
        An error occurred, please try again later!
      </div>
    </div>
  </div>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const attemptTypeRadios = document.querySelectorAll('input[name="attemptType"]');
      attemptTypeRadios.forEach(radio => {
        radio.addEventListener('change', function () {
          const attemptsSection = document.getElementById('attemptsSection');
          if (this.id === 'flash') {
            attemptsSection.style.display = 'none';
          } else {
            attemptsSection.style.display = 'block';
          }
        });
      });

      function updateAttemptsDisplay(value) {
        return value + (value === 1 ? ' try' : ' tries');
      }

      document.getElementById('increaseAttempts').addEventListener('click', function () {
        const attemptsInput = document.getElementById('attempts');
        let numericValue = parseInt(attemptsInput.value);
        if (numericValue < 10) {
          attemptsInput.value = updateAttemptsDisplay(numericValue + 1);
        }
      });

      document.getElementById('decreaseAttempts').addEventListener('click', function () {
        const attemptsInput = document.getElementById('attempts');
        let numericValue = parseInt(attemptsInput.value);
        if (numericValue > 1) {
          attemptsInput.value = updateAttemptsDisplay(numericValue - 1);
        }
      });

      // Manual grade mapping
      const gradeMapping = {  
        "4a/V0": "10",
        "4b/V0": "11",
        "4c/V0": "12",
        "5a/V1": "13",
        "5b/V1": "14",
        "5c/V2": "15",
        "6a/V3": "16",
        "6a+/V3": "17",
        "6b/V4": "18",
        "6b+/V4": "19",
        "6c/V5": "20",
        "6c+/V5": "21",
        "7a/V6": "22",
        "7a+/V7": "23",
        "7b/V8": "24",
        "7b+/V8": "25",
        "7c/V9": "26",
        "7c+/V10": "27",
        "8a/V11": "28",
        "8a+/V12": "29",
        "8b/V13": "30",
        "8b+/V14": "31",
        "8c/V15": "32",
        "8c+/V16": "33",
      };

      const gradeKeys = Object.keys(gradeMapping);
      let currentGradeIndex = gradeKeys.indexOf(document.getElementById('difficulty').value);

      function schwierigkeits(increase) {
        if (increase && currentGradeIndex < gradeKeys.length - 1) {
          currentGradeIndex++;
        } else if (!increase && currentGradeIndex > 0) {
          currentGradeIndex--;
        }
        const difficultyInput = document.getElementById('difficulty');
        difficultyInput.value = gradeKeys[currentGradeIndex];
      
        const event = new Event('change');
        difficultyInput.dispatchEvent(event);
      }

      const difficultyInput = document.getElementById('difficulty');
      currentGradeIndex = gradeKeys.indexOf(difficultyInput.value);
      if (currentGradeIndex === -1) {
        currentGradeIndex = 0; // Default to the first grade if not found
        difficultyInput.value = gradeKeys[currentGradeIndex];
      }

      document.getElementById('increaseDifficulty').addEventListener('click', function () {
        schwierigkeits(true);
      });

      document.getElementById('decreaseDifficulty').addEventListener('click', function () {
        schwierigkeits(false);
      });

      document.getElementById('difficulty').addEventListener('change', function () {
        currentGradeIndex = gradeKeys.indexOf(this.value);
        if (currentGradeIndex === -1) {
          currentGradeIndex = 0;
          this.value = gradeKeys[currentGradeIndex];
        }
      });

      // Reset star rating and comment when the modal is opened
      const tickModal = document.getElementById('tickModal');
      tickModal.addEventListener('show.bs.modal', function () {
        // Reset star rating
        const starRadios = document.querySelectorAll('.star-rating input');
        starRadios.forEach(radio => radio.checked = false);

        // Reset comment
        document.getElementById('comment').value = '';
        // Reset disabled save button
        document.getElementById('saveTick').disabled = false;
      });
    });

      document.getElementById('saveTick').addEventListener('click', function () {
        this.disabled = true; // Disable the button to prevent multiple submissions
      });
  </script>

<!-- Stats Modal -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Statistics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="paragraph-climb-attempts"></p>
      </div>
    </div>
  </div>
</div>

<!-- Logout Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to logout?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-primary" id="confirmLogout">Yes</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById('confirmLogout').addEventListener('click', function () {
    document.cookie.split(";").forEach(function (cookie) {
      document.cookie = cookie.trim().split("=")[0] + '=; Max-Age=0; path=/;';
    });
    location.reload();
  });
</script>

    <script src="{{url_for('static', filename='js/bluetooth.js')}}"></script>
    <script src="{{url_for('static', filename='js/common.js')}}"></script>
    <script>
      const appUrl = "{{ app_url }}";
      const colors = {{ colors | tojson}};
      const ledColors = {{ led_colors | tojson}};
      const attemptedClimbs = {{ attempted_climbs | tojson}};
      const tickedClimbs = {{ ticked_climbs | tojson}};
      const placementPositions = {{ placement_positions | tojson}};
      drawBoard('svg-climb', {{ images_to_holds | tojson}}, {{ edge_left }}, {{ edge_right }}, {{ edge_bottom }}, {{ edge_top }});
    </script>
    <script src="{{url_for('static', filename='js/results.js')}}"></script>
    <script src="{{url_for('static', filename='js/swipe.js')}}"></script>

</body>

</html>
